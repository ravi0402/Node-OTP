'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var https = require('https');
var http = require('http');

var HttpClient = function () {
  function HttpClient(options) {
    _classCallCheck(this, HttpClient);

    this.port = 443 || options.port;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json'
    };
    this.logger = options.logger;

    if (options.userAgent) {
      this.headers['User-Agent'] = options.userAgent;
    }
  }

  _createClass(HttpClient, [{
    key: 'request',
    value: function request(endpoint, method, callback) {
      var _this = this;

      if (typeof method == 'function') {
        callback = method;
        endpoint.method = endpoint.method || 'GET';
      } else if (typeof method !== 'undefined') {
        endpoint.method = method;
      }

      if (endpoint.method == 'POST' || endpoint.method == 'DELETE') {
        // TODO: verify the following fix is required
        // Fix broken due ot 411 Content-Length error now sent by Nexmo API
        // PL 2016-Sept-6 - commented out Content-Length 0
        // headers['Content-Length'] = 0;
      }
      var options = {
        host: endpoint.host ? endpoint.host : 'rest.nexmo.com',
        port: this.port,
        path: endpoint.path,
        method: endpoint.method,
        headers: this.headers
      };

      // Allow existing headers to be overridden
      // Allow new headers to be added
      if (endpoint.headers) {
        Object.keys(endpoint.headers).forEach(function (key) {
          options.headers[key] = endpoint.headers[key];
        });
      }

      this.logger.info('Request:', options, '\nBody:', endpoint.body);
      var request;

      if (options.port == 443) {
        request = this.https.request(options);
      } else {
        request = http.request(options);
      }

      request.end(endpoint.body);

      // Keep an array of String or Buffers,
      // depending on content type (binary or JSON) of response
      var responseData = [];

      request.on('response', function (response) {
        var isBinary = response.headers['content-type'] === 'application/octet-stream';
        if (!isBinary) {
          response.setEncoding('utf8');
        }

        response.on('data', function (chunk) {
          responseData.push(chunk);
        });

        response.on('end', function () {
          _this.logger.info('response ended:', response.statusCode);
          if (callback) {
            if (isBinary) {
              responseData = Buffer.concat(responseData);
            }

            _this.__parseReponse(response.status, response.headers['content-type'], responseData, method, callback);
          }
        });
        response.on('close', function (e) {
          _this.logger.error('problem with API request detailed stacktrace below ');
          _this.logger.error(e);
          callback(e);
        });
      });
      request.on('error', function (e) {
        _this.logger.error('problem with API request detailed stacktrace below ');
        _this.logger.error(e);
        callback(e);
      });
    }
  }, {
    key: '__parseReponse',
    value: function __parseReponse(status, contentType, data, method, callback) {
      var response = null;
      var error = null;

      try {
        if (status >= 500) {
          error = { message: 'Server Error: ' + status };
        } else if (status >= 400 || status < 200) {
          error = JSON.parse(data);
        } else if (contentType === 'application/octet-stream') {
          response = data;
        } else if (method !== 'DELETE') {
          response = JSON.parse(data);
        } else {
          response = data;
        }
      } catch (parseError) {
        this.logger.error(parseError);
        this.logger.error('could not convert API response to JSON, above error is ignored and raw API response is returned to client');
        this.logger.error('Raw Error message from API ');
        this.logger.error(data);

        error = {
          message: "The API response could not be parsed.",
          parseError: parseError
        };
      }

      callback(error, response);
    }
  }]);

  return HttpClient;
}();

exports.default = HttpClient;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJIdHRwQ2xpZW50Iiwib3B0aW9ucyIsInBvcnQiLCJoZWFkZXJzIiwibG9nZ2VyIiwidXNlckFnZW50IiwiZW5kcG9pbnQiLCJtZXRob2QiLCJjYWxsYmFjayIsImhvc3QiLCJwYXRoIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJpbmZvIiwiYm9keSIsInJlcXVlc3QiLCJlbmQiLCJyZXNwb25zZURhdGEiLCJvbiIsInJlc3BvbnNlIiwiaXNCaW5hcnkiLCJzZXRFbmNvZGluZyIsImNodW5rIiwicHVzaCIsInN0YXR1c0NvZGUiLCJCdWZmZXIiLCJjb25jYXQiLCJfX3BhcnNlUmVwb25zZSIsInN0YXR1cyIsImUiLCJlcnJvciIsImNvbnRlbnRUeXBlIiwiZGF0YSIsIm1lc3NhZ2UiLCJKU09OIiwicGFyc2UiLCJwYXJzZUVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsSUFBSUEsUUFBUUMsUUFBUSxPQUFSLENBQVo7QUFDQSxJQUFJQyxPQUFPRCxRQUFRLE1BQVIsQ0FBWDs7SUFFTUUsVTtBQUNKLHNCQUFZQyxPQUFaLEVBQXFCO0FBQUE7O0FBQ25CLFNBQUtDLElBQUwsR0FBWSxPQUFPRCxRQUFRQyxJQUEzQjtBQUNBLFNBQUtMLEtBQUwsR0FBYUksUUFBUUosS0FBUixJQUFpQkEsS0FBOUI7QUFDQSxTQUFLRSxJQUFMLEdBQWFFLFFBQVFGLElBQVIsSUFBZ0JBLElBQTdCO0FBQ0EsU0FBS0ksT0FBTCxHQUFlO0FBQ1gsc0JBQWdCLG1DQURMO0FBRVgsZ0JBQVU7QUFGQyxLQUFmO0FBSUEsU0FBS0MsTUFBTCxHQUFjSCxRQUFRRyxNQUF0Qjs7QUFFQSxRQUFHSCxRQUFRSSxTQUFYLEVBQXNCO0FBQ3BCLFdBQUtGLE9BQUwsQ0FBYSxZQUFiLElBQTZCRixRQUFRSSxTQUFyQztBQUNEO0FBQ0Y7Ozs7NEJBRU9DLFEsRUFB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cENsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XG52YXIgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcblxuY2xhc3MgSHR0cENsaWVudCB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICB0aGlzLnBvcnQgPSA0NDMgfHwgb3B0aW9ucy5wb3J0O1xuICAgIHRoaXMuaHR0cHMgPSBvcHRpb25zLmh0dHBzIHx8IGh0dHBzO1xuICAgIHRoaXMuaHR0cCA9ICBvcHRpb25zLmh0dHAgfHwgaHR0cDtcbiAgICB0aGlzLmhlYWRlcnMgPSB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyxcbiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgIH07XG4gICAgdGhpcy5sb2dnZXIgPSBvcHRpb25zLmxvZ2dlcjtcblxuICAgIGlmKG9wdGlvbnMudXNlckFnZW50KSB7XG4gICAgICB0aGlzLmhlYWRlcnNbJ1VzZXItQWdlbnQnXSA9IG9wdGlvbnMudXNlckFnZW50O1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3QoZW5kcG9pbnQsIG1ldGhvZCwgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIG1ldGhvZCA9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNhbGxiYWNrID0gbWV0aG9kO1xuICAgICAgICBlbmRwb2ludC5tZXRob2QgPSBlbmRwb2ludC5tZXRob2QgfHwgJ0dFVCc7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBtZXRob2QgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBcdGVuZHBvaW50Lm1ldGhvZCA9IG1ldGhvZDtcbiAgICB9XG5cbiAgICBpZiAoZW5kcG9pbnQubWV0aG9kID09ICdQT1NUJyB8fCBlbmRwb2ludC5tZXRob2QgPT0gJ0RFTEVURScpIHtcbiAgICAgICAgLy8gVE9ETzogdmVyaWZ5IHRoZSBmb2xsb3dpbmcgZml4IGlzIHJlcXVpcmVkXG4gICAgICAgIC8vIEZpeCBicm9rZW4gZHVlIG90IDQxMSBDb250ZW50LUxlbmd0aCBlcnJvciBub3cgc2VudCBieSBOZXhtbyBBUElcbiAgICAgICAgLy8gUEwgMjAxNi1TZXB0LTYgLSBjb21tZW50ZWQgb3V0IENvbnRlbnQtTGVuZ3RoIDBcbiAgICAgICAgLy8gaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IDA7XG4gICAgfVxuICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgICBob3N0OiBlbmRwb2ludC5ob3N0P2VuZHBvaW50Lmhvc3Q6J3Jlc3QubmV4bW8uY29tJyxcbiAgICAgICAgcG9ydDogdGhpcy5wb3J0LFxuICAgICAgICBwYXRoOiBlbmRwb2ludC5wYXRoLFxuICAgICAgICBtZXRob2Q6IGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzXG4gICAgfTtcblxuICAgIC8vIEFsbG93IGV4aXN0aW5nIGhlYWRlcnMgdG8gYmUgb3ZlcnJpZGRlblxuICAgIC8vIEFsbG93IG5ldyBoZWFkZXJzIHRvIGJlIGFkZGVkXG4gICAgaWYoZW5kcG9pbnQuaGVhZGVycykge1xuICAgICAgT2JqZWN0LmtleXMoZW5kcG9pbnQuaGVhZGVycykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgb3B0aW9ucy5oZWFkZXJzW2tleV0gPSBlbmRwb2ludC5oZWFkZXJzW2tleV07XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdSZXF1ZXN0OicsIG9wdGlvbnMsICdcXG5Cb2R5OicsIGVuZHBvaW50LmJvZHkpO1xuICAgIHZhciByZXF1ZXN0O1xuXG4gICAgaWYgKG9wdGlvbnMucG9ydCA9PSA0NDMpIHtcbiAgICAgICAgcmVxdWVzdCA9IHRoaXMuaHR0cHMucmVxdWVzdChvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXF1ZXN0ID0gaHR0cC5yZXF1ZXN0KG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJlcXVlc3QuZW5kKGVuZHBvaW50LmJvZHkpO1xuXG4gICAgLy8gS2VlcCBhbiBhcnJheSBvZiBTdHJpbmcgb3IgQnVmZmVycyxcbiAgICAvLyBkZXBlbmRpbmcgb24gY29udGVudCB0eXBlIChiaW5hcnkgb3IgSlNPTikgb2YgcmVzcG9uc2VcbiAgICB2YXIgcmVzcG9uc2VEYXRhID0gW107XG5cbiAgICByZXF1ZXN0Lm9uKCdyZXNwb25zZScsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICB2YXIgaXNCaW5hcnkgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9PT0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7XG4gICAgICAgIGlmICghaXNCaW5hcnkpIHsgcmVzcG9uc2Uuc2V0RW5jb2RpbmcoJ3V0ZjgnKTsgfVxuXG4gICAgICAgIHJlc3BvbnNlLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgcmVzcG9uc2VEYXRhLnB1c2goY2h1bmspO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXNwb25zZS5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygncmVzcG9uc2UgZW5kZWQ6JywgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgaWYgKGlzQmluYXJ5KSB7IHJlc3BvbnNlRGF0YSA9IEJ1ZmZlci5jb25jYXQocmVzcG9uc2VEYXRhKTsgfVxuXG4gICAgICAgICAgICAgIHRoaXMuX19wYXJzZVJlcG9uc2UoXG4gICAgICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YSxcbiAgICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICAgICAgY2FsbGJhY2tcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgcmVzcG9uc2Uub24oJ2Nsb3NlJywgKGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdwcm9ibGVtIHdpdGggQVBJIHJlcXVlc3QgZGV0YWlsZWQgc3RhY2t0cmFjZSBiZWxvdyAnKTtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlcXVlc3Qub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ3Byb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93ICcpO1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgfSk7XG5cbiAgfVxuXG4gIF9fcGFyc2VSZXBvbnNlKHN0YXR1cywgY29udGVudFR5cGUsIGRhdGEsIG1ldGhvZCwgY2FsbGJhY2spIHtcbiAgICB2YXIgcmVzcG9uc2UgPSBudWxsO1xuICAgIHZhciBlcnJvciA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHN0YXR1cyA+PSA1MDApIHtcbiAgICAgICAgZXJyb3IgPSB7IG1lc3NhZ2U6ICdTZXJ2ZXIgRXJyb3I6ICcrc3RhdHVzIH07XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA+PSA0MDAgfHwgc3RhdHVzIDwgMjAwKSB7XG4gICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgIH0gZWxzZSBpZiAoY29udGVudFR5cGUgPT09ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nKSB7XG4gICAgICAgIHJlc3BvbnNlID0gZGF0YTtcbiAgICAgIH0gZWxzZSBpZiAobWV0aG9kICE9PSAnREVMRVRFJykge1xuICAgICAgICByZXNwb25zZSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNwb25zZSA9IGRhdGE7XG4gICAgICB9XG4gICAgfSBjYXRjaCAocGFyc2VFcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocGFyc2VFcnJvcik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignY291bGQgbm90IGNvbnZlcnQgQVBJIHJlc3BvbnNlIHRvIEpTT04sIGFib3ZlIGVycm9yIGlzIGlnbm9yZWQgYW5kIHJhdyBBUEkgcmVzcG9uc2UgaXMgcmV0dXJuZWQgdG8gY2xpZW50Jyk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignUmF3IEVycm9yIG1lc3NhZ2UgZnJvbSBBUEkgJyk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihkYXRhKTtcblxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIG1lc3NhZ2U6IFwiVGhlIEFQSSByZXNwb25zZSBjb3VsZCBub3QgYmUgcGFyc2VkLlwiLFxuICAgICAgICBwYXJzZUVycm9yOiBwYXJzZUVycm9yXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNhbGxiYWNrKGVycm9yLCByZXNwb25zZSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSHR0cENsaWVudDtcbiJdfQ==